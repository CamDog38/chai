<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contact – chai.</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/aileron" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="case-studies.css" />
</head>
<body class="page--contact">
  <!-- Fixed Left Menu -->
  <aside class="left-menu" aria-label="Primary">
    <a href="/" class="left-menu__logo" aria-label="Chai Home">
      <img src="Images/Chai White ver2.png" alt="Chai logo" />
    </a>
    <button class="left-menu__toggle" aria-expanded="false" aria-controls="leftFlyout" title="Open menu">+</button>
    <nav id="leftFlyout" class="left-flyout" aria-hidden="true">
      <ul>
        <li><a href="/">home.</a></li>
        <li>
          <a href="/index#services">services.</a>
          <ul class="submenu" aria-label="Services submenu">
            <li><a href="/mediaportfolio">media portfolio.</a></li>
            <li><a href="/sportmediasportfolio">sports media portfolio.</a></li>
          </ul>
        </li>
        <li><a href="/index#about">about us.</a></li>
        <li><a href="/index#case-studies">case studies.</a></li>
        <li><a href="/contact" class="active">contact us.</a></li>
      </ul>
    </nav>
    <div class="left-menu__spacer" aria-hidden="true"></div>
    <div class="left-menu__socials">
        <a href="https://www.linkedin.com/company/chai-digital-communications/ " aria-label="LinkedIn" class="sm sm--in">in</a>
        <a href="https://www.instagram.com/chaidigital?igsh=NjMxY3Q4ODlkdzYy&utm_source=qr" aria-label="Instagram" class="sm sm--ig">ig</a>
    </div>
  </aside>

  <main>
    <section class="contact-hero">
      <div class="contact-hero__bg-text" aria-hidden="true">contact us.</div>
      <div class="contact-hero__content layer-text">
        <h2 class="copy-head animate-in">contact us.</h2>
        <p class="contact-copy animate-in" style="margin-left:0; animation-delay: 0.1s">please fill out the form below and let's create work that is <i class="accent-serif">made to matter</i>.</p>

        <form id="contactForm" class="contact-form animate-in" novalidate style="animation-delay: 0.2s">
          <div class="form-row">
            <div class="field">
              <label for="name">name</label>
              <input id="name" name="name" type="text" required />
            </div>
            <div class="field">
              <label for="company">company</label>
              <input id="company" name="company" type="text" />
            </div>
          </div>
          <div class="form-row">
            <div class="field">
              <label for="email">email</label>
              <input id="email" name="email" type="email" required />
            </div>
            <div class="field">
              <label for="phone">phone</label>
              <input id="phone" name="phone" type="tel" />
            </div>
          </div>
          <div class="form-row">
            <div class="field full">
              <label for="message">message</label>
              <textarea id="message" name="message" required></textarea>
            </div>
          </div>
          <!-- Honeypot field (hidden from users) -->
          <div class="field" style="position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;">
            <label for="website">website</label>
            <input id="website" name="website" type="text" autocomplete="off" tabindex="-1" />
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn--primary">send</button>
          </div>
          <p id="formNote" class="body-text" style="color:var(--muted); margin-top:12px"></p>
        </form>
      </div>
    </section>
  </main>

  <script defer>
    // Left menu toggle
    (function(){
      const menu = document.querySelector('.left-menu');
      const btn = document.querySelector('.left-menu__toggle');
      const fly = document.getElementById('leftFlyout');
      if(!menu || !btn || !fly) return;
      btn.addEventListener('click', ()=>{
        const open = menu.classList.toggle('is-open');
        btn.setAttribute('aria-expanded', String(open));
        fly.setAttribute('aria-hidden', String(!open));
      });
      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && menu.classList.contains('is-open')) {
          menu.classList.remove('is-open');
          btn.setAttribute('aria-expanded', 'false');
          fly.setAttribute('aria-hidden', 'true');
        }
      });
    })();

    // Form submission with webhook, client-side rate limiting and basic anti-spam
    (function(){
      const form = document.getElementById('contactForm');
      const note = document.getElementById('formNote');
      const btn = form?.querySelector('button[type="submit"]');
      if(!form) return;

      // Track form render time to enforce minimum fill time
      const FORM_MIN_MS = 2000; // 2s
      const startAt = Date.now();

      // Simple sliding-window rate limit in localStorage
      const RL_KEY = 'contact_submits_v1';
      const RL_WINDOW_MS = 10 * 60 * 1000; // 10 minutes
      const RL_MAX = 3; // max submissions per window

      function getHistory(){
        try { return JSON.parse(localStorage.getItem(RL_KEY) || '[]'); } catch (e) { console.warn('[contact] rl parse error', e); return []; }
      }
      function putHistory(arr){
        try { localStorage.setItem(RL_KEY, JSON.stringify(arr)); } catch {}
      }

      function isRateLimited(){
        const now = Date.now();
        const recent = getHistory().filter(ts => now - ts < RL_WINDOW_MS);
        return { limited: recent.length >= RL_MAX, recent };
      }

      // Lightly obfuscate webhook URL and sign payload so you can filter in Zapier
      const WEBHOOK_B64 = 'aHR0cHM6Ly9ob29rcy56YXBpZXIuY29tL2hvb2tzL2NhdGNoLzY1MTA2NjQvdXJjMHljci8='; // https://hooks.zapier.com/hooks/catch/6510664/urc0ycr/
      const WEBHOOK_URL = atob(WEBHOOK_B64);
      const PEPPER = 'sj3Jw7Vf-chi-contact-v1'; // client-exposed; use server if possible

      async function sha256Hex(input){
        const data = new TextEncoder().encode(input);
        const hash = await crypto.subtle.digest('SHA-256', data);
        const bytes = Array.from(new Uint8Array(hash));
        return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!btn) return;
        console.groupCollapsed('%c[contact] submit','color:#6cf');
        try{

        // Honeypot check
        const hp = (document.getElementById('website')?.value || '').trim();
        if (hp.length) console.warn('[contact] honeypot tripped');
        if (hp.length){
          // Silently accept to confuse bots
          note.textContent = 'thanks!';
          return;
        }

        // Minimum fill time
        const elapsed = Date.now() - startAt;
        console.log('[contact] elapsed ms', elapsed);
        if (elapsed < FORM_MIN_MS){
          note.textContent = 'please take a moment to complete the form.';
          return;
        }

        // Rate limiting
        const { limited, recent } = isRateLimited();
        console.log('[contact] rl check', { limited, recent });
        if (limited){
          const retryMs = RL_WINDOW_MS - (Date.now() - recent[0]);
          const mins = Math.ceil(retryMs / 60000);
          note.textContent = `you have reached the limit. please try again in about ${mins} minute(s).`;
          return;
        }

        // Validate required fields
        const name = (document.getElementById('name').value||'').trim();
        const email = (document.getElementById('email').value||'').trim();
        const company = (document.getElementById('company').value||'').trim();
        const phone = (document.getElementById('phone').value||'').trim();
        const message = (document.getElementById('message').value||'').trim();
        console.log('[contact] values', { name, email, company, phone, messageLen: message.length });
        if(!name || !email || !message){
          note.textContent = 'please complete your name, email, and message.';
          return;
        }

        // Disable and POST to webhook
        btn.disabled = true;
        btn.textContent = 'sending…';
        const now = Date.now();
        const updated = [...recent.filter(ts => now - ts < RL_WINDOW_MS), now];
        putHistory(updated);

        const payload = {
          name, email, company, phone, message,
          meta: {
            userAgent: navigator.userAgent,
            url: location.href,
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
            ts: now,
            elapsedMs: now - startAt,
            rlCount: updated.length,
          },
          // anti-spam markers
          honeypot: hp,
          minTimePassed: elapsed >= FORM_MIN_MS,
        };
        const signature = await sha256Hex(`${now}:${email}:${name}:${PEPPER}`);
        console.log('[contact] webhook', { url: WEBHOOK_URL.replace(/https:\/\//,'https://…/').slice(0,60)+'…', payload });

        try{
          // Approach: use CORS-safe simple request (no custom headers) via FormData and no-cors
          // Cleaner payload: a single JSON field + signature
          const cleaned = {
            form: 'chai-contact-v1',
            ts: now,
            contact: { name, email, company, phone, message },
            meta: {
              tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
              userAgent: navigator.userAgent,
              url: location.href
            },
            antiSpam: {
              honeypot: hp,
              minTimePassed: elapsed >= FORM_MIN_MS,
              elapsedMs: now - startAt,
              rlCount: updated.length
            }
          };
          const fd = new FormData();
          fd.append('json', JSON.stringify(cleaned));
          fd.append('sig', signature);
          fd.append('form', 'chai-contact-v1');

          // Abort after 12s (note: AbortController is not honored by some UAs in no-cors)
          const ctrl = new AbortController();
          const t = setTimeout(() => ctrl.abort('timeout'), 12000);
          const res = await fetch(WEBHOOK_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: fd,
            keepalive: true,
            signal: ctrl.signal
          });
          clearTimeout(t);
          console.log('[contact] response (opaque ok expected)', res && { type: res.type, redirected: res.redirected });
          // In no-cors mode, res.ok/status are not readable (opaque). Assume success if no exception.
          note.textContent = 'thanks — we received your message. we\'ll be in touch soon.';
          form.reset();
        } catch(err){
          console.error('[contact] webhook error', err);
          // Fallback to mailto so the user can still reach you
          const subject = encodeURIComponent(`New inquiry from ${name}`);
          const body = encodeURIComponent(`Name: ${name}\nEmail: ${email}\nPhone: ${phone}\nCompany: ${company}\n\nMessage:\n${message}`);
          try { window.location.href = `mailto:cameron@digitaljunction.ae?subject=${subject}&body=${body}`; } catch {}
          note.textContent = 'sorry, something went wrong. please email cameron@digitaljunction.ae directly.';
        } finally {
          btn.disabled = false;
          btn.textContent = 'send';
        }
        } finally {
          console.groupEnd();
        }
      });
    })();
  </script>
</body>
</html>
